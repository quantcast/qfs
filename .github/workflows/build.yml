name: Build

on: [push, pull_request]

jobs:
  rat:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: rat
        run: make rat clean

  linux-build:
    strategy:
      matrix:
        codecov: [no]
        btype: [release]
        buser: [qfsbuild]
        include:
          - distro: ubuntu
            ver: 18.04
            btype: debug
          - distro: ubuntu
            ver: 18.04
            buser: root
          - distro: ubuntu
            ver: 16.04
          - distro: ubuntu
            ver: 14.04
          - distro: centos
            ver: 6
          - distro: centos
            ver: 7
          - distro: debian
            ver: 9
    runs-on: ubuntu-latest
    env:
      TRAVIS_OS_NAME: linux
      BUILD_RUN_DOCKER: 'no'
      DISTRO: ${{ matrix.distro }}
      VER: ${{ matrix.ver }}
      CODECOV: ${{ matrix.codecov }}
      BTYPE: ${{ matrix.btype }}
      BUSER: ${{ matrix.buser }}
    container:
      image: ${{ matrix.distro }}:${{ matrix.ver }}
    steps:
      - name: Update git and install curl
        run: |
          if [ x"$DISRTO" = x'centos' ]; then
            if [ x"$VER" = x'6' ]; then
              yum install -y 'http://opensource.wandisco.com/centos/6/git/x86_64/wandisco-git-release-6-1.noarch.rpm'
            else
              yum install -y 'http://opensource.wandisco.com/centos/7/git/x86_64/wandisco-git-release-7-2.noarch.rpm'
            fi
            yum install -y git curl
          else
            apt-get update \
            && apt-get install software-properties-common -y \
            && add-apt-repository ppa:git-core/ppa -y \
            && apt-get update \
            && apt-get install git curl -y
          fi

      - name: Checkout code
        uses: actions/checkout@v2

      - name: Linux build
        run: travis/script.sh

  osx-build:
    runs-on: macos-latest
    env:
      TRAVIS_OS_NAME: osx
    steps:
      - name: Brew install
        run: |
          brew install boost || true
          brew install osxfuse || true

      - name: Checkout code
        uses: actions/checkout@v2

      - name: MacOS build
        run: travis/script.sh
