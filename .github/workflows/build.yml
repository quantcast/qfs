name: Build

on: [push, pull_request]

jobs:
  rat:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: rat
        run: make rat clean

  linux-build:
    strategy:
      matrix:
        distro: [ubuntu, centos, debian]
        exclude:
          - distro: ubuntu
          - distro: i386/ubuntu
          - distro: centos
          - distro: debian
        include:
          - distro: ubuntu
            ver: 18.04
            codecov: no
            btype: release
            buser: qfsbuild
          - distro: ubuntu
            ver: 18.04
            codecov: yes
            btype: release
            buser: qfsbuild
          - distro: ubuntu
            ver: 18.04
            codecov: no
            btype: debug
            buser: qfsbuild
          - distro: ubuntu
            ver: 18.04
            codecov: no
            btype: release
            buser: root
          - distro: ubuntu
            ver: 16.04
            codecov: no
            btype: release
            buser: qfsbuild
          - distro: ubuntu
            ver: 14.04
            codecov: no
            btype: release
            buser: qfsbuild
          - distro: debian
            ver: 10
            codecov: no
            btype: release
            buser: qfsbuild
          - distro: centos
            ver: 7
            codecov: no
            btype: release
            buser: qfsbuild
          - distro: centos
            ver: 8
            codecov: no
            btype: release
            buser: qfsbuild
    runs-on: ubuntu-latest
    env:
      TRAVIS_OS_NAME: linux
      BUILD_RUN_DOCKER: 'no'
      DISTRO: ${{ matrix.distro }}
      VER: ${{ matrix.ver }}
      CODECOV: ${{ matrix.codecov }}
      BTYPE: ${{ matrix.btype }}
      BUSER: ${{ matrix.buser }}
    container:
      image: ${{ matrix.distro }}:${{ matrix.ver }}
    steps:
      - name: Update git and install curl
        run: |
          if [ x"$DISTRO" = x'centos' ]; then
            yum update -y
            yum upgrade -y
            if [ x"$VER" = x'7' ]; then
              yum install -y 'http://opensource.wandisco.com/centos/7/git/x86_64/wandisco-git-release-7-2.noarch.rpm'
            fi
            yum install -y git curl
          else
            if [ x"$DISTRO" = x'ubuntu' \
                -a \( x'VER' = x'14.04' \
                  -o x'VER' = x'16.04' -o x'VER' = x'18.04' \) ]; then
              apt-get update \
              && apt-get install software-properties-common -y \
              && add-apt-repository ppa:git-core/ppa -y
            fi
            apt-get update \
            && apt-get install git curl -y
          fi

      - name: Checkout code
        uses: actions/checkout@v2

      - name: Linux build
        run: travis/script.sh

  osx-build:
    runs-on: macos-latest
    env:
      TRAVIS_OS_NAME: osx
    steps:
      - name: Brew install
        run: |
          brew install boost || true
          brew install osxfuse || true

      - name: Checkout code
        uses: actions/checkout@v2

      - name: MacOS build
        run: travis/script.sh
