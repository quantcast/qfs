name: Build

on: [push, pull_request]

jobs:
  rat:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: rat
        run: make rat clean

  linux-build-docker:
    strategy:
      matrix:
        distro: [ubuntu, centos, debian, i386/ubuntu]
        exclude:
          - distro: ubuntu
          - distro: centos
          - distro: debian
          - distro: i386/ubuntu
        include:
          - distro: ubuntu
            ver: 20.04
            codecov: no
            btype: release
            buser: qfsbuild
          - distro: ubuntu
            ver: 18.04
            codecov: no
            btype: release
            buser: qfsbuild
          - distro: ubuntu
            ver: 18.04
            codecov: yes
            btype: release
            buser: qfsbuild
          - distro: ubuntu
            ver: 18.04
            codecov: no
            btype: debug
            buser: qfsbuild
          - distro: ubuntu
            ver: 18.04
            codecov: no
            btype: release
            buser: root
          - distro: ubuntu
            ver: 16.04
            codecov: no
            btype: release
            buser: qfsbuild
          - distro: ubuntu
            ver: 14.04
            codecov: no
            btype: release
            buser: qfsbuild
          - distro: debian
            ver: 9
            codecov: no
            btype: release
            buser: qfsbuild
          - distro: debian
            ver: 10
            codecov: no
            btype: release
            buser: qfsbuild
          - distro: centos
            ver: 5
            codecov: no
            btype: release
            buser: qfsbuild
          - distro: centos
            ver: 6
            codecov: no
            btype: release
            buser: qfsbuild
          - distro: centos
            ver: 7
            codecov: no
            btype: release
            buser: qfsbuild
          - distro: centos
            ver: 8
            codecov: no
            btype: release
            buser: qfsbuild
          - distro: i386/ubuntu
            ver: 18.04
            codecov: no
            btype: release
            buser: qfsbuild
    runs-on: ubuntu-latest
    env:
      BUILD_OS_NAME: linux
      BUILD_RUN_DOCKER: 'yes'
      DISTRO: ${{ matrix.distro }}
      VER: ${{ matrix.ver }}
      CODECOV: ${{ matrix.codecov }}
      BTYPE: ${{ matrix.btype }}
      BUSER: ${{ matrix.buser }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Linux docker build
        run: |
          travis/script.sh
          sudo chown "$USER" .git/config

      - name: Upload tarball
        if: >
          ${{ ('refs/heads/master' == github.ref
          || 'refs/heads/topic/github_actions' == github.ref
          || startsWith(github.ref, 'refs/tags/'))
          && 'yes' != matrix.codecov
          && 'release' == matrix.btype
          && 'qfsbuild' == matrix.buser }}
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: us-east-1
        run: aws s3 cp build/qfs-*.tgz s3://quantcast-qfs

  osx-build:
    runs-on: macos-latest
    env:
      BUILD_OS_NAME: osx
    steps:
      - name: Brew install
        run: |
          brew install boost || true
          brew install osxfuse || true

      - name: Checkout code
        uses: actions/checkout@v2

      - name: MacOS build
        run: travis/script.sh

      - name: Upload tarball
        if: >
          ${{ 'refs/heads/master' == github.ref
          || 'refs/heads/topic/github_actions' == github.ref
          || startsWith(github.ref, 'refs/tags/') }}
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: us-east-1
        run: aws s3 cp build/qfs-*.tgz s3://quantcast-qfs
